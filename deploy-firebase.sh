#!/bin/bash

# Firebase deployment script for Spandex Salvation Radio
# Deploy to https://www.spandex-salvation-radio.com/
# Deploy to custom domain https://www.spandex-salvation-radio.com/

echo "üî• Starting Firebase deployment for Spandex Salvation Radio..."

# Check if Firebase CLI is installed
if ! command -v firebase &> /dev/null; then
    echo "‚ùå Firebase CLI not found. Installing..."
    npm install -g firebase-tools
fi

# Git operations
echo "üìù Git Operations..."
echo "=================="

# Check if we're in a git repository
if ! git rev-parse --git-dir > /dev/null 2>&1; then
    echo "‚ùå Not in a git repository! Please run this from your project root."
    exit 1
fi

# Get current branch
current_branch=$(git branch --show-current)
echo "üìç  Current Branch: $current_branch"

# Show all available branches with numbering
echo ""
# Get main branch first (if it exists), then other branches
main_branch=$(git branch --format='%(refname:short)' | grep -E '^main$' | head -1)
other_branches=$(git branch --format='%(refname:short)' | grep -v '^main$' | sort)

# Count total branches
total_branches=0
if [ -n "$main_branch" ]; then
    total_branches=$((total_branches + 1))
fi
if [ -n "$other_branches" ]; then
    total_branches=$((total_branches + $(echo "$other_branches" | wc -l)))
fi

echo "ü™æ All Branches (1 - $total_branches):"

# Display numbered branches
branch_number=1
if [ -n "$main_branch" ]; then
    echo "$branch_number. $main_branch"
    branch_number=$((branch_number + 1))
fi
if [ -n "$other_branches" ]; then
    while IFS= read -r branch; do
        if [ -n "$branch" ]; then
            echo "$branch_number. $branch"
            branch_number=$((branch_number + 1))
        fi
    done <<< "$other_branches"
fi

# Ask for target branch
echo ""
read -p "üåø Enter the branch name or number to commit to (e.g., main) or (1) or press Enter for current branch: " target_branch

# If no input provided, default to current branch
if [ -z "$target_branch" ]; then
    target_branch="$current_branch"
    echo "‚úÖ Using current branch: $target_branch"
fi

# Validate branch input
if [ -z "$target_branch" ]; then
    echo "‚ùå Branch name cannot be empty!"
    exit 1
fi

# Check if input is a number and convert to branch name if needed
if [[ "$target_branch" =~ ^[0-9]+$ ]]; then
    # Convert number to branch name
    branch_number=1
    selected_branch=""
    
    if [ -n "$main_branch" ]; then
        if [ "$target_branch" -eq "$branch_number" ]; then
            selected_branch="$main_branch"
        fi
        branch_number=$((branch_number + 1))
    fi
    
    if [ -z "$selected_branch" ] && [ -n "$other_branches" ]; then
        while IFS= read -r branch; do
            if [ -n "$branch" ]; then
                if [ "$target_branch" -eq "$branch_number" ]; then
                    selected_branch="$branch"
                    break
                fi
                branch_number=$((branch_number + 1))
            fi
        done <<< "$other_branches"
    fi
    
    if [ -n "$selected_branch" ]; then
        echo "‚úÖ Selected branch: $selected_branch"
        target_branch="$selected_branch"
    else
        echo "‚ùå Invalid branch number: $target_branch"
        exit 1
    fi
fi

# Check if target branch exists, if not ask to create it
if ! git show-ref --verify --quiet refs/heads/$target_branch; then
    echo "‚ö†Ô∏è  Branch '$target_branch' doesn't exist."
    read -p "ü§î Would you like to create it? (y/n): " create_branch
    if [[ $create_branch =~ ^[Yy]$ ]]; then
        echo "üåø Creating new branch: $target_branch"
        git checkout -b $target_branch
    else
        echo "‚ùå Deployment cancelled. Please create the branch manually or choose an existing one."
        exit 1
    fi
else
    # Switch to target branch
    echo "üîÑ Switching to branch: $target_branch"
    git checkout $target_branch
fi

# Check for uncommitted changes
if ! git diff-index --quiet HEAD --; then
    echo "üìã You have uncommitted changes. Let's commit them!"
    
    # Add all changes
    echo "‚ûï Adding all changes..."
    git add .
    
    # Ask for commit message
    echo ""
    read -p "üí¨ Enter your commit message or press Enter for default: " commit_message
    
    # If no input provided, use default message
    if [ -z "$commit_message" ]; then
        commit_message="Deploy to Firebase - $(date '+%Y-%m-%d %H:%M:%S')"
        echo "‚úÖ Using default commit message: $commit_message"
    fi
    
    # Validate commit message
    if [ -z "$commit_message" ]; then
        echo "‚ùå Commit message cannot be empty!"
        exit 1
    fi
    
    # Commit changes
    echo "üíæ Committing changes..."
    git commit -m "$commit_message"
    
    if [ $? -eq 0 ]; then
        echo "‚úÖ Commit successful!"
    else
        echo "‚ùå Commit failed!"
        exit 1
    fi
else
    echo "‚úÖ No uncommitted changes found."
fi

# Push to remote (optional)
echo ""
read -p "üöÄ Push changes to remote repository? (y/n): " push_changes
if [[ $push_changes =~ ^[Yy]$ ]]; then
    echo "üì§ Pushing to remote..."
    git push origin $target_branch
    
    if [ $? -eq 0 ]; then
        echo "‚úÖ Push successful!"
    else
        echo "‚ùå Push failed! Continuing with deployment anyway..."
    fi
fi

echo ""
echo "üöÄ Starting Firebase Deployment..."
echo "================================"

# Build the client
echo "üì¶ Building client application..."

cd client
npm run build

if [ $? -ne 0 ]; then
    echo "‚ùå Client build failed!"
    exit 1
fi

echo "‚úÖ Client build successful!"

# Return to root directory
cd ..

# Login to Firebase (if not already logged in)
echo "üîê Checking Firebase authentication..."
firebase login --interactive

# Deploy Firebase Functions first
echo "‚ö° Deploying Firebase Functions..."
firebase deploy --only functions

if [ $? -ne 0 ]; then
    echo "‚ùå Functions deployment failed!"
    exit 1
fi

echo "‚úÖ Functions deployment successful!"

# Deploy to Firebase Hosting
echo "üöÄ Deploying to Firebase Hosting..."
firebase deploy --only hosting

if [ $? -eq 0 ]; then
    echo "‚úÖ Deployment successful!"
    echo "üé• Your site is now live at: https://spandex-salvation-radio-site.web.app"
    echo "üåê Custom domain: https://www.spandex-salvation-radio.com/"
    echo "üå§Ô∏è Weather API is now available at: /api/weather"
    echo "üìù Changes committed to branch: $target_branch"
else
    echo "‚ùå Hosting deployment failed!"
    exit 1
fi

echo "üé∏ Rock on! Your radio station site changes are live! üé∏"